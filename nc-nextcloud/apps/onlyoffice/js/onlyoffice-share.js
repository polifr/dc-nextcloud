(()=>{"use strict";!function(e,i){OCA.Onlyoffice=_.extend({AppName:"onlyoffice"},OCA.Onlyoffice),OCA.Onlyoffice.Permissions={None:0,Review:1,Comment:2,FillForms:4,ModifyFilter:8};var n=null,o=new OCA.Files.Sidebar.Tab({id:"onlyofficeSharingTabView",name:t(OCA.Onlyoffice.AppName,"Advanced"),iconSvg:'<?xml version="1.0" encoding="utf-8"?>\n\x3c!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --\x3e\n<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n\t viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve">\n<style type="text/css">\n\t.st0{opacity:0.42;enable-background:new    ;}\n\t.st1{opacity:0.72;enable-background:new    ;}\n</style>\n<g id="XMLID_5_">\n\t<path id="XMLID_3_" class="st0" d="M6.9,15.2l-6.4-3.1c-0.6-0.2-0.6-0.7,0-0.9l2.2-1.1l4.2,2c0.6,0.2,1.4,0.2,2,0l4.2-2l2.2,1.1\n\t\tc0.6,0.2,0.6,0.7,0,0.9L9,15.2C8.4,15.4,7.5,15.4,6.9,15.2L6.9,15.2z"/>\n\t<path id="XMLID_2_" class="st1" d="M6.9,11.5L0.5,8.5c-0.6-0.2-0.6-0.7,0-0.9l2.2-1.1l4.2,2c0.6,0.2,1.4,0.2,2,0l4.3-2l2.2,1\n\t\tc0.6,0.2,0.6,0.7,0,0.9L9,11.4C8.4,11.8,7.5,11.8,6.9,11.5L6.9,11.5z"/>\n\t<path id="XMLID_1_" d="M6.9,7.9L0.5,4.8c-0.6-0.2-0.6-0.7,0-0.9l6.4-3.1c0.6-0.2,1.4-0.2,2,0l6.4,3.1c0.6,0.2,0.6,0.7,0,0.9\n\t\tL8.9,7.9C8.4,8.1,7.5,8.1,6.9,7.9L6.9,7.9z"/>\n</g>\n</svg>\n',mount(e,i,o){n||(n=s()),n.init(e,i)},update(e){n.update(e)},destroy(){n.clear()},enabled(i){var o=!1;if(!i.isDirectory()){var s=OCA.Onlyoffice.getFileExtension(i.name),l=OCA.Onlyoffice.setting.formats[s];l&&(l.review||l.comment||l.fillForms||l.modifyFilter)&&(o=!0,(e("#sharing").hasClass("active")||e("#tab-button-sharing").hasClass("active"))&&n.fileInfo&&n.fileInfo.id==i.id&&this.update(i))}return o}}),s=function(){var n=null,o=null,s=null,l=null,r=null,a=null,f=null,c=function(){return n.find(".onlyoffice-share-container")},O=function(o){0===n.find(".onlyoffice-share-container").length&&(e("<ul>",{class:"onlyoffice-share-container"}).appendTo(n),e("<div>").html(t(OCA.Onlyoffice.AppName,"Provide advanced document permissions using ONLYOFFICE Docs")).prependTo(n)),f?o():e.get(i.filePath(OCA.Onlyoffice.AppName,"templates","share.html"),(function(i){f=e(i),o()}))},m=function(e){var i=a.getValues(),n=a.getTargetId(),o=s.id,r=l.find((e=>e.share_id==n)),f=OCA.Onlyoffice.Permissions.None;i[OCA.Onlyoffice.Permissions.Review]&&(f|=OCA.Onlyoffice.Permissions.Review),i[OCA.Onlyoffice.Permissions.Comment]&&(f&OCA.Onlyoffice.Permissions.Review)!=OCA.Onlyoffice.Permissions.Review&&(f&OCA.Onlyoffice.Permissions.ModifyFilter)!=OCA.Onlyoffice.Permissions.ModifyFilter&&(f|=OCA.Onlyoffice.Permissions.Comment),i[OCA.Onlyoffice.Permissions.FillForms]&&(f&OCA.Onlyoffice.Permissions.Review)!=OCA.Onlyoffice.Permissions.Review&&(f|=OCA.Onlyoffice.Permissions.FillForms),i[OCA.Onlyoffice.Permissions.ModifyFilter]&&(f&OCA.Onlyoffice.Permissions.Comment)!=OCA.Onlyoffice.Permissions.Comment&&(f|=OCA.Onlyoffice.Permissions.ModifyFilter),a.block(!0),OCA.Onlyoffice.SetShares(r.id,n,o,f,(e=>{l.forEach((i=>{i.share_id==e.share_id&&(i.id=e.id,i.permissions=e.permissions,i.available=e.available)}));var i=p(e);a.refresh(i),a.block(!1)}))},d=function(i){a||(a=y());var n=e(i.target).closest(".onlyoffice-share-item")[0].id;if(a.isOpen()){var o=a.getTargetId();if(a.close(),o==n)return}var s=l.find((e=>e.share_id==n)),r=p(s);a.open(s.share_id,r,e(i.target).position())},p=function(e){var i=[];if(o.review&&(OCA.Onlyoffice.Permissions.Review&e.available)===OCA.Onlyoffice.Permissions.Review){var n=(OCA.Onlyoffice.Permissions.Review&e.permissions)===OCA.Onlyoffice.Permissions.Review;i.push({checked:n,extra:OCA.Onlyoffice.Permissions.Review,label:t(OCA.Onlyoffice.AppName,"Review only")})}if(o.comment&&(OCA.Onlyoffice.Permissions.Comment&e.available)===OCA.Onlyoffice.Permissions.Comment){var s=(OCA.Onlyoffice.Permissions.Comment&e.permissions)===OCA.Onlyoffice.Permissions.Comment;i.push({checked:s,extra:OCA.Onlyoffice.Permissions.Comment,label:t(OCA.Onlyoffice.AppName,"Comment only")})}if(o.fillForms&&(OCA.Onlyoffice.Permissions.FillForms&e.available)===OCA.Onlyoffice.Permissions.FillForms){var l=(OCA.Onlyoffice.Permissions.FillForms&e.permissions)===OCA.Onlyoffice.Permissions.FillForms;i.push({checked:l,extra:OCA.Onlyoffice.Permissions.FillForms,label:t(OCA.Onlyoffice.AppName,"Form filling")})}if(o.modifyFilter&&(OCA.Onlyoffice.Permissions.ModifyFilter&e.available)===OCA.Onlyoffice.Permissions.ModifyFilter){var r=(OCA.Onlyoffice.Permissions.ModifyFilter&e.permissions)===OCA.Onlyoffice.Permissions.ModifyFilter;i.push({checked:r,extra:OCA.Onlyoffice.Permissions.ModifyFilter,label:t(OCA.Onlyoffice.AppName,"Global filter")})}return i},y=function(){var i=e("<div>",{class:"popovermenu onlyoffice-share-popup"}).append(e("<ul>"),{id:-1}),o=function(n,o,s){var l=e("<li>").append(e("<span>",{class:"onlyoffice-share-action"}).append(e("<input>",{id:"extra-"+o,type:"checkbox",class:"checkbox action-checkbox__checkbox focusable",checked:n})).append(e("<label>",{for:"extra-"+o,text:s,class:"onlyoffice-share-label"})));l.find("input").click(m),i.find("ul").append(l)},s=function(){var e=i.find("li");e&&e.remove()},l=function(e){i.find("ul").attr("id",e)};return n.append(i),{isOpen:function(){return i.is(":visible")},open:function(e,n,r){s(),r&&i.css({top:r.top}),n.forEach((e=>{o(e.checked,e.extra,e.label)})),l(e),i.show()},close:function(){s(),l(-1),i.hide()},refresh:function(e){s(),e.forEach((e=>{o(e.checked,e.extra,e.label)}))},block:function(e){i.find("input").prop("disabled",e)},getValues:function(){for(var e=[],n=i.find("input"),o=0;o<n.length;o++){e[n[o].id.split("extra-")[1]]=n[o].checked}return e},getTargetId:function(){return i.find("ul").attr("id")}}};return{get fileInfo(){return s},init:function(i,o){n=e(i),O((()=>{this.update(o)}))},update:function(n){var m;null===r&&(m=!1,(r={on:function(){m||(e("#content").on("click",(function(i){var n=e(i.target)[0];a&&a.isOpen()&&"onlyoffice-share-action"!=n.id&&"onlyoffice-share-label"!=n.className&&!n.closest(".onlyoffice-share-action")&&a.close()})),m=!0)}}).on()),c().children().remove(),s=n;var p=OCA.Onlyoffice.getFileExtension(s.name);o=OCA.Onlyoffice.setting.formats[p],OCA.Onlyoffice.GetShares(s.id,(e=>{l=e,O((()=>{l.forEach((e=>{var n=f.clone(),o=n.find("span"),s=n.find("img"),l=n.find("#onlyoffice-share-action"),r="/index.php/avatar/"+e.shareWith+"/32?v=0",a=e.shareWithName;e.type!=i.Share.SHARE_TYPE_GROUP&&e.type!=i.Share.SHARE_TYPE_ROOM||(r="/index.php/avatar/guest/"+e.shareWith+"/32?v=0",a=e.shareWith+" ("+t(OCA.Onlyoffice.AppName,"group")+")"),e.type==i.Share.SHARE_TYPE_ROOM&&(a=e.shareWith+" ("+t(OCA.Onlyoffice.AppName,"conversation")+")"),e.type==i.Share.SHARE_TYPE_LINK&&(a=t(OCA.Onlyoffice.AppName,"Share link"),n.find(".avatardiv").addClass("onlyoffice-share-link-avatar"),r="/core/img/actions/public.svg"),l.click(d),s[0].src=r,o[0].innerText=a,n[0].id=e.share_id,c().append(n)}))}))}))},clear:function(){n=null,o=null,s=null,l=null,a=null}}};OCA.Onlyoffice.GetShares=function(n,o){e.ajax({url:i.linkToOCS("apps/"+OCA.Onlyoffice.AppName+"/api/v1/shares",2)+n+"?format=json",success:function(e){o(e.ocs.data)}})},OCA.Onlyoffice.SetShares=function(n,o,s,l,r){var a={extraId:n,shareId:o,fileId:s,permissions:l};e.ajax({method:"PUT",url:i.linkToOCS("apps/"+OCA.Onlyoffice.AppName+"/api/v1",2)+"shares?format=json",data:a,success:function(e){r(e.ocs.data)}})},OCA.Files.Sidebar&&OCA.Files.Sidebar.registerTab&&OCA.Files.Sidebar.registerTab(o)}(jQuery,OC)})();
//# sourceMappingURL=onlyoffice-share.js.map?v=cbbc943d31673454563d